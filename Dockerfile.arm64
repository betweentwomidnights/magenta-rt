# ARM64 optimized Dockerfile for DGX Spark (based on official magenta-rt Dockerfile)
FROM nvidia/cuda:13.0.1-runtime-ubuntu24.04

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    TF_FORCE_GPU_ALLOW_GROWTH=true \
    XLA_PYTHON_CLIENT_PREALLOCATE=false \
    TF_GPU_ALLOCATOR=cuda_malloc_async \
    TF_ENABLE_CUBLAS_TF32=1 \
    NVIDIA_TF32_OVERRIDE=1 \
    JAX_PLATFORMS=""

SHELL ["/bin/bash", "-c"]
WORKDIR /magenta-realtime

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common curl ca-certificates \
    build-essential pkg-config git \
    libsndfile1 ffmpeg \
    && add-apt-repository ppa:deadsnakes/ppa -y \
    && apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-dev python3.11-venv python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Make python3.11 default and install uv
RUN ln -sf /usr/bin/python3.11 /usr/bin/python && \
    ln -sf /usr/bin/python3.11 /usr/bin/python3 && \
    python -m pip install --ignore-installed uv --break-system-packages

# CRITICAL FOR ARM64: Install TensorFlow FIRST to block tensorflow-cpu
# No tensorflow-text needed - we'll patch it out of seqio!
RUN uv pip install --system tf-nightly

# Install JAX with CUDA support
RUN uv pip install --system "jax[cuda12]" jaxlib

# Install base dependencies that everything needs
RUN uv pip install --system \
    absl-py chex gin-config numpy requests tqdm typing-extensions \
    google-cloud-storage librosa resampy soundfile sentencepiece

# Clone and install t5x WITHOUT its dependencies (to avoid tensorflow-cpu)
RUN git clone https://github.com/google-research/t5x.git /t5x && \
    cd /t5x && \
    git checkout 92c5b467a5964d06c351c7eae4aa4bcd341c7ded && \
    uv pip install --system --no-deps -e .

# Install flaxformer without deps
RUN git clone https://github.com/google/flaxformer.git /flaxformer && \
    cd /flaxformer && \
    git checkout 399ea3a && \
    uv pip install --system --no-deps -e .

# Install seqio without deps  
RUN git clone https://github.com/google/seqio.git /seqio && \
    cd /seqio && \
    uv pip install --system --no-deps -e . && \
    # CRITICAL: Remove unused tensorflow_text import (not needed by Magenta RT)
    sed -i '/import tensorflow_text as tf_text/d' /seqio/seqio/vocabularies.py

# Install airio (t5x dependency) without deps
RUN git clone https://github.com/google/airio.git /airio && \
    cd /airio && \
    uv pip install --system --no-deps -e .

# Install clu without deps
RUN git clone https://github.com/google/CommonLoopUtils.git /clu && \
    cd /clu && \
    uv pip install --system --no-deps -e .

# Now install all the remaining dependencies these packages need
RUN uv pip install --system \
    flax optax orbax-checkpoint \
    fiddle cached_property tf2jax \
    aqtp etils jestimator \
    tensorflow-datasets tfds-nightly \
    apache-beam pyyaml rouge-score sacrebleu scipy \
    grain-nightly editdistance pyglove

# Patch jestimator for newer JAX - PartitionSpec moved to jax.sharding
RUN sed -i 's|from jax.experimental.pjit import PartitionSpec|from jax.sharding import PartitionSpec|g' \
    /usr/local/lib/python3.11/dist-packages/jestimator/amos_helper.py

# Install magenta-realtime without deps
RUN git clone https://github.com/magenta/magenta-realtime.git /magenta-realtime-src && \
    cd /magenta-realtime-src && \
    uv pip install --system --no-deps -e .

# API and audio processing dependencies
RUN uv pip install --system \
    fastapi uvicorn[standard] python-multipart \
    pyloudnorm gradio soxr huggingface_hub

# Ensure compatible protobuf version (TensorFlow 2.18+ needs protobuf 5.27+)
RUN uv pip install --system --force-reinstall "protobuf>=5.27.0"

# Set working directory and create cache
WORKDIR /app
ENV MAGENTA_RT_CACHE_DIR=/root/.cache/magenta_rt
RUN mkdir -p $MAGENTA_RT_CACHE_DIR

# Copy application files
COPY app.py /app/
COPY utils.py /app/
COPY jam_worker.py /app/
COPY one_shot_generation.py /app/
COPY model_management.py /app/
COPY documentation.html /app/
COPY lil_demo_540p.mp4 /app/
COPY magentaRT_rt_tester.html /app/
COPY magenta_prompts.js /app/
COPY docs/ /app/docs/

EXPOSE 7860
CMD ["python", "-m", "uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7860"]